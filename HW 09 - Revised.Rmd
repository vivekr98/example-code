---
title: "HW 09"
author: "Vivek Ramakrishnan"
date: "11/28/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(dplyr)
library(ggplot2)
library(RCurl)
library(rvest)
library(purrr)
library(magrittr)
library(tidytext)
library(twitteR)
library(knitr)
library(memisc)
library(reshape2)
library(scales)
library(rtweet)
library(tm)
library(caret)
options(digits =3)
set.seed(1234)
```


Ariana Grande is largely considered one of the most prolific artists **of all time**. Essential to being a popstar in 2018 is your social media presence. Grande is quite active over Twitter and has gained a substantial following after the release of her hit song, 'Thank u Next'. Her tweets range from feuds with Piers Morgan, interacting with fans, and a budding friendship with Mark Hamil.

[](skywalker.png)

In this assignment, I will perform a sentiment analysis on Grande's tweets, as well as some classification to examine the temporal trends of her Twitter feed and her favorite counts by tweet. 

### Dataset

I use the `twitteR` package to retrieve the 4000 most recent tweets by Ariana Grande, not including retweets. I created a Twitter Development account and created and stored API keys and tokens for accessing the app in my .Rprofile page. I call the retrived tweets `grande`

```{r}
grande <- get_timeline(user = 'ArianaGrande',
                      n = 4000,
                      include_rts = FALSE)
grande
```

A quick glance at Ariana Grande's Twitter feed shows that she interacts with her fans, other celebrities, and haters quite a bit. She interacts with others primarily by quoting tweets she has recieved. The following graph shows the total number of quoted tweets vs. normal tweets in her last 4000 tweets.

```{r}
grande %>% 
  count(status_id, is_quote) %>% 
  ggplot() + 
  geom_bar(aes(x = is_quote, y = n, fill = is_quote), 
           stat = 'identity')
```

Some of her quoted tweets, especially ones that are rather pointed, garner a lot more favorites than individual tweets replying to fans

[](grande_piers.png)

The following bar graph shows the average number of favorites for quoted tweets vs. normal tweets.

```{r}
grande %>% 
  group_by(is_quote) %>% 
  summarize(n = mean(favorite_count)) %>%
  ggplot() + 
  geom_bar(aes(x = is_quote, y = n, fill = is_quote), 
           stat = 'identity')
```


Clearly there is some interesting relationship between Grande's content and the number of favorites she recieves. I am interested in preforming a text analysis on Ariana Grande's Twitter feed to determine which types of tweets and sentiments recieve the most favorites.

First, I tidy the data, split each tweet by word, and remove stopwords and links. I then categorized the number of favorites into 5 categories, from very low to very high. The breaks I chose for this categorization was somewhat arbitrary; I have seen Ariana Grande's tweets on my timeline range from less than 50,000 favorites to over 600,000 favorites. The other delineations were randomly chosen from inuition. 

```{r}
reg <- "([^A-Za-z\\d#@']|'(?![A-Za-z\\d#@]))"

grande_tidy <- grande %>%
  rowid_to_column('ID') %>%
  dplyr::select(text, favorite_count, retweet_count, ID) %>%
  filter(!str_detect(text, '^"')) %>%
  mutate(text = str_replace_all(text, "https://t.co/[A-Za-z\\d]+|&amp;", "")) %>%
  unnest_tokens(word, text, token = "regex", pattern = reg) %>%
  filter(!word %in% stop_words$word,
         str_detect(word, "[a-z]")) %>%
  anti_join(stop_words) %>%
  mutate(fav=cut(favorite_count, breaks=c(0, 50000, 100000, 300000, 600000, Inf), labels=c('very low',"low","middle","high",'very high')))



grande_tidy
```

After cleaning and categorizing the data I wanted to know the words that appeared the most in the different favorite classes of her Tweets.

```{r}

grande_tidy %>%
  # delete stopwords
  anti_join(stop_words) %>%
  # summarize count per word per book
  count(fav, word) %>%
  # highest freq on top
  arrange(desc(n)) %>% 
  # identify rank within group
  group_by(fav) %>% 
  mutate(top = seq_along(word)) %>%
  # retain top 15 frequent words
  filter(top <= 10) %>%
  # create barplot
  ggplot(aes(x = -top, y = n, fill = fav)) + 
  geom_col(color = "black") +
  # print words in plot instead of as axis labels
  geom_text(aes(label = word), hjust = "left", nudge_y = 100) +
  labs(title = "Most frequent words in Harry Potter",
       x = NULL,
       y = "Word count") +
  facet_wrap( ~ fav) +
  coord_flip() +
  theme(legend.position = "none",
        # rotate x text
        axis.text.x = element_text(angle = 45, hjust = 1),
        # remove tick marks and text on y-axis
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())
```

From the graphs, the majority of her tweets fall under 'very low' favorites distinction I created. Or tweets with less than 50k favorites. Interestingly, the most common word Grande uses across four favorites categories is love, while for the highest-favorite tweets, the most common word is beautiful. The lowest-favorited tweets included two Twitter handles; likely belonging to 'stan' accounts - or Twitter accounts dedicated to tweeting at and about Grande. The tweets with the highest number of favorites have high frequency words dedicated to deeper and more weighty subjects; including 'time', 'universe', and 'life'. 


```{r}
(grande_tfidf <- grande_tidy %>%
  count(fav, word)  %>%
   bind_tf_idf(term = word, document = fav, n = n))

plot_grande <- grande_tfidf %>%
  arrange(desc(tf_idf))  %>%
  mutate(word = factor(word, levels = rev(unique(word))))


# graph the top 10 tokens for 4 categories
plot_grande %>%
  group_by(fav) %>%
  slice(1:6) %>%
  ungroup() %>%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  labs(x = NULL, y = "tf-idf") +
  facet_wrap(~fav, scales = "free") +
  coord_flip()

```

```{r}
(grande_nrc <- grande_tidy %>%
  inner_join(get_sentiments('nrc')) %>%
  group_by(ID, sentiment))


grande_nrc %>%
  ungroup %>%
  count(word, sentiment)  %>%
  arrange(desc(n)) %>%
  group_by(sentiment) %>% # 
  mutate(top = seq_along(word)) %>%
  # retain top 15 frequent words
  filter(top <= 15) %>%
  # create barplot
  ggplot(aes(x = -top, y = n, fill = sentiment)) + 
  geom_col(color = "black") +
  # print words in plot instead of as axis labels
  geom_text(aes(label = word), hjust = "left", nudge_y = 100) +
  labs(title = "Most frequent words in Tweets",
       x = NULL,
       y = "Word count") +
  facet_wrap( ~ sentiment, ncol = 5) +
  coord_flip() +
  theme(legend.position = "none",
        # rotate x text
        axis.text.x = element_text(angle = 45, hjust = 1),
        # remove tick marks and text on y-axis
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())
```


```{r}

(grande_tfidf <- grande_tidy %>%
  count(fav, word)  %>%
   bind_tf_idf(term = word, document = fav, n = n))

plot_grande <- grande_tfidf %>%
  arrange(desc(tf_idf))  %>%
  mutate(word = factor(word, levels = rev(unique(word))))


# graph the top 10 tokens for 4 categories
plot_grande %>%
  group_by(fav) %>%
  top_n(4) %>%
  ungroup() %>%
  ggplot(aes(word, tf_idf)) +
  geom_col() +
  labs(x = NULL, y = "tf-idf") +
  facet_wrap(~fav, scales = "free") +
  coord_flip()
```

```{r}
(grande_tfidf <- grande_tidy %>%
  count(fav, word)  %>%
   bind_tf_idf(term = word, document = fav, n = n))
```



```{r}

(grande_nrc <- grande_tidy %>%
  inner_join(get_sentiments('nrc')) %>%
  group_by(ID, sentiment))


grande_nrc %>%
  ungroup %>%
  count(word, sentiment)  %>%
  arrange(desc(n)) %>%
  group_by(sentiment) %>% # 
  mutate(top = seq_along(word)) %>%
  # retain top 15 frequent words
  filter(top <= 5) %>%
  # create barplot
  ggplot(aes(x = -top, y = n, fill = sentiment)) + 
  geom_col(color = "black") +
  # print words in plot instead of as axis labels
  geom_text(aes(label = word), hjust = "left", nudge_y = 100) +
  labs(title = "Most frequent words in Tweets",
       x = NULL,
       y = "Word count") +
  ylim(c(-1,900)) +
  facet_wrap( ~ sentiment, ncol = 5) +
  coord_flip() +
  theme(legend.position = "none",
        # rotate x text
        axis.text.x = element_text(angle = 45, hjust = 1),
        # remove tick marks and text on y-axis
        axis.ticks.y = element_blank(),
        axis.text.y = element_blank())

```

```{r}
grande_afinn <- grande_tidy %>%
  inner_join(get_sentiments('afinn')) %>%
  group_by(ID, fav) %>%
  summarize(avg_score = sum(score))

ariana_count <- grande_tidy %>%
  count(fav)

grande_afinn2 <- grande_afinn %>%
    group_by(fav) %>%
    summarize(score = mean(avg_score))  %>%
    inner_join(ariana_count) %>%
    mutate(sign = ifelse(score > 0, 'positive', 
                         ifelse(score < 0, 'negative', 'something else')))


kable(grande_afinn2)

ggplot(grande_afinn2) + geom_bar(aes(x=reorder(fav, -score), score, fill = sign), stat = 'identity') 

```